# Module: Prompt Composition Rules

## Purpose

Определяет правила и ограничения композиции модулей при создании промптов.
Дополняет prompt-system-architecture-standard.md нормативными требованиями к синтаксису и обработке маркеров.

## Specification

### 1. Правила синтаксиса маркеров

**Обязательный формат маркера:**

```
{{путь/к/модулю.md}}
```

**Требования к синтаксису:**

- Открывающий маркер: `{{` (строго две фигурные скобки)
- Закрывающий маркер: `}}` (строго две фигурные скобки)
- Путь: относительный от корня проекта
- Пробелы: НЕ ДОПУСКАЮТСЯ внутри маркера

### 2. Запреты на синтаксис

**ЗАПРЕЩЁННЫЕ форматы:**

```markdown
{{ путь/к/модулю.md }}          ❌ пробелы внутри маркера
{путь/к/модулю.md}              ❌ одна фигурная скобка
{{./путь/к/модулю.md}}          ❌ относительный путь с ./
{{../путь/к/модулю.md}}         ❌ относительный путь с ../
{{ {{вложенный}} }}             ❌ пробелы в композиции
```

**Правило:** Любое отклонение от формата `{{путь}}` без пробелов - ошибка синтаксиса.

### 3. Правило композиции модулей

**При включении модуля через маркер `{{путь/к/модулю.md}}`:**

**ОБЯЗАТЕЛЬНО:**

1. **Читать ТОЛЬКО секцию `## Specification`**
   - Это исполняемая часть модуля
   - Только она влияет на поведение

2. **ИГНОРИРОВАТЬ секции `## Purpose` и `## Version`**
   - Это мета-информация для разработчиков
   - Не влияет на исполнение (инвариант из module-structure-standard)

3. **Рекурсивно обрабатывать вложенные маркеры**
   - Если в `Specification` встречаются `{{...}}`, развернуть их
   - Применять те же правила к вложенным модулям

**Обоснование:**

- Секция `Specification` содержит только поведенческие инструкции
- Включение мета-информации загрязняет итоговый промпт
- Уменьшает потребление токенов LLM
- Обеспечивает чистоту композиции

### 4. Требования к путям модулей

**Формат пути:**

```
prompts/modules/[тип]/[имя-модуля].md
```

**Правила:**

- Путь ВСЕГДА относительный от корня проекта
- Путь ДОЛЖЕН начинаться с `prompts/modules/`
- Файл ДОЛЖЕН иметь расширение `.md`
- НЕ использовать `./` или `../` в пути

**Примеры корректных путей:**

```markdown
{{prompts/modules/roles/prompt-creation.md}}
{{prompts/modules/standards/module-structure-standard.md}}
{{prompts/modules/instructions/role-activation.md}}
{{prompts/modules/rules/module-creation-rules.md}}
```

### 5. Правила рекурсивной обработки

**Алгоритм обработки маркера:**

1. Прочитать файл по указанному пути
2. Извлечь ТОЛЬКО секцию `## Specification`
3. Найти в ней все маркеры `{{...}}`
4. Для каждого вложенного маркера:
   - Рекурсивно применить шаги 1-3
   - Подставить результат на место маркера
5. Вернуть итоговый текст

**Порядок развёртывания:**

- Развёртывание происходит в порядке появления маркеров (сверху вниз)
- Вложенные маркеры развёртываются перед родительскими
- Глубина вложенности не ограничена

### 6. Правило изоляции команд

**Команды (`prompts/commands/*.md`) НЕ являются модулями:**

- НЕ имеют структуры Purpose/Specification/Version
- НЕ включаются через маркеры `{{...}}`
- Являются корнем композиции (точка входа)
- Могут включать модули, но сами не включаются

**Правило:** Команды - это контейнеры для композиции, не переиспользуемые блоки.

### 7. Правило ручной обработки маркеров

**Критическое требование:**

Маркеры `{{...}}` **НЕ работают автоматически**:

- Требуют ручной обработки агентом LLM
- Агент должен прочитать файл и извлечь Specification
- Система не выполняет автоматическую подстановку

**Правило:** При встрече маркера `{{путь}}` агент обязан прочитать файл и выполнить композицию согласно правилам.

### 8. Правило минимизации токенов

**При композиции:**

- Включать только необходимые модули
- Использовать ленивую загрузку для редко используемых модулей
- Не дублировать содержимое модулей
- Игнорировать мета-информацию (Purpose/Version)

**Правило:** Композиция должна быть минимальной для достижения цели.

## Version

* Version: 1.0
* Created: 2025-12-24
* Status: Active
* Notes: Extracted composition rules from prompt-system-architecture-standard.md
